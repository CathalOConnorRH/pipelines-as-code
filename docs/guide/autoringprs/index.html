<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Authoring PipelineRuns in .tekton/ directory #    Pipelines as Code will always try to be as close to the tekton template as possible. Usually you will write your template and save them with a &ldquo;.yaml&rdquo; extension and Pipelines as Code will run them.
  Using its resolver Pipelines as Code will try to bundle the PipelineRun with all its Task as a single PipelineRun with no external dependencies."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Authoring PipelineRun"><meta property="og:description" content="Authoring PipelineRuns in .tekton/ directory #    Pipelines as Code will always try to be as close to the tekton template as possible. Usually you will write your template and save them with a &ldquo;.yaml&rdquo; extension and Pipelines as Code will run them.
  Using its resolver Pipelines as Code will try to bundle the PipelineRun with all its Task as a single PipelineRun with no external dependencies."><meta property="og:type" content="article"><meta property="og:url" content="/docs/guide/autoringprs/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2022-03-29T13:50:13+02:00"><title>Authoring PipelineRun | Pipelines as Code</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.8629c295117a93381e50c4509eee27c9e25c0832c243c6213d959c2024241ec8.js></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/pipelines-logo.svg alt=Logo><span>Pipelines as Code</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/docs/install/>Installation</a><ul><li><a href=/docs/install/overview/>Overview</a></li><li><a href=/docs/install/installation/>Infrastructure install</a></li><li><a href=/docs/install/settings/>Settings</a></li><li><a href=/docs/install/github_apps/>Github Apps</a></li><li><a href=/docs/install/github_webhook/>Github Webhook</a></li><li><a href=/docs/install/gitlab/>Gitlab</a></li><li><a href=/docs/install/bitbucket_cloud/>Bitbucket Cloud</a></li><li><a href=/docs/install/bitbucket_server/>Bitbucket Server</a></li><li><a href=/docs/install/kubernetes/>Kubernetes</a></li></ul></li><li><a href=/docs/guide/>Usage Guide</a><ul><li><a href=/docs/guide/repositorycrd/>Repository CRD</a></li><li><a href=/docs/guide/resolver/>Resolver</a></li><li><a href=/docs/guide/autoringprs/ class=active>Authoring PipelineRun</a></li><li><a href=/docs/guide/running/>Running the PipelineRun</a></li><li><a href=/docs/guide/statuses/>PipelineRun status</a></li><li><a href=/docs/guide/privaterepo/>Private Repositories</a></li><li><a href=/docs/guide/cleanups/>PipelineRuns Cleanup</a></li><li><a href=/docs/guide/cli/>CLI tkn-pac</a></li></ul></li></ul><ul><li><a href=https://github.com/openshift-pipelines/pipelines-as-code target=_blank rel=noopener>Github Pipelines as Code</a></li><li><a href=https://tekton.dev/docs/ target=_blank rel=noopener>TektonCD Documentation</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Authoring PipelineRun</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#matching-an-event-to-a-pipelinerun>Matching an event to a PipelineRun</a></li><li><a href=#advanced-event-matching>Advanced event matching</a></li><li><a href=#example>Example</a></li></ul></nav></aside></header><article class=markdown><h1 id=authoring-pipelineruns-in-tekton-directory>Authoring PipelineRuns in <code>.tekton/</code> directory
<a class=anchor href=#authoring-pipelineruns-in-tekton-directory>#</a></h1><ul><li><p>Pipelines as Code will always try to be as close to the tekton template as
possible. Usually you will write your template and save them with a &ldquo;.yaml&rdquo;
extension and Pipelines as Code will run them.</p></li><li><p>Using its <a href=./resolver>resolver</a> Pipelines as Code will try to bundle the
PipelineRun with all its Task as a single PipelineRun with no external
dependencies.</p></li><li><p>Inside your pipeline you need to be able to check out the commit as
received from the webhook by checking it out the repository from that ref. Most of the time
you want to reuse the
<a href=https://github.com/tektoncd/catalog/blob/main/task/git-clone/>git-clone</a>
task from the <a href=https://github.com/tektoncd/catalog>tektoncd/catalog</a>.</p><p>To be able to specify the parameters of your commit and url, Pipelines as Code
allows you to have those &ldquo;dynamic&rdquo; variables expanded. Those variables look
like this <code>{{ var }}</code> and those are the one you can use:</p><ul><li><code>{{repo_owner}}</code>: The repository owner.</li><li><code>{{repo_name}}</code>: The repository name.</li><li><code>{{repo_url}}</code>: The repository full URL.</li><li><code>{{revision}}</code>: The commit full sha revision.</li><li><code>{{sender}}</code>: The sender username (or accountid on some providers) of the commit.</li><li><code>{{source_branch}}</code>: The branch name where the event come from.</li><li><code>{{target_branch}}</code>: The branch name on which the event targets (same as <code>source_branch</code> for push events).</li></ul></li><li><p>You need at least one <code>PipelineRun</code> with a <code>PipelineSpec</code> or a separated
<code>Pipeline</code> object. You can have embedded <code>TaskSpec</code> inside
<code>Pipeline</code> or you can have them defined separately as <code>Task</code>.</p></li></ul><h2 id=matching-an-event-to-a-pipelinerun>Matching an event to a PipelineRun
<a class=anchor href=#matching-an-event-to-a-pipelinerun>#</a></h2><p>Each <code>PipelineRun</code> can match different git provider events via some special
annotations on the <code>PipelineRun</code>. For example when you have these metadatas in
your <code>PipelineRun</code>:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span> <span style=color:#f92672>metadata</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span><span style=color:#111>:</span> <span style=color:#ae81ff>pipeline-pr-main</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>annotations</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>pipelinesascode.tekton.dev/on-target-branch</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;[main]&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>pipelinesascode.tekton.dev/on-event</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;[pull_request]&#34;</span>
</span></span></code></pre></div><p><code>Pipelines as Code</code> will match the pipelinerun <code>pipeline-pr-main</code> if the git
provider events target the branch <code>main</code> and it&rsquo;s coming from a <code>[pull_request]</code></p><p>Multiple target branch can be specified separated by comma, i.e:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#111>[</span><span style=color:#ae81ff>main, release-nightly]</span>
</span></span></code></pre></div><p>You can match on <code>pull_request</code> events as above and you can as well match
pipelineRuns on <code>push</code> events to a repository</p><p>For example this will match the pipeline when there is a push to a commit in the
<code>main</code> branch :</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span> <span style=color:#f92672>metadata</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span><span style=color:#111>:</span> <span style=color:#ae81ff>pipeline-push-on-main</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>pipelinesascode.tekton.dev/on-target-branch</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;[refs/heads/main]&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>pipelinesascode.tekton.dev/on-event</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;[push]&#34;</span>
</span></span></code></pre></div><p>You can specify the full refs like <code>refs/heads/main</code> or the shortref like
<code>main</code>. You can as well specify globs, for example <code>refs/heads/*</code> will match any
target branch or <code>refs/tags/1.*</code> will match all the tags starting from <code>1.</code>.</p><p>A full example for a push of a tag :</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span> <span style=color:#f92672>metadata</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>name</span><span style=color:#111>:</span> <span style=color:#ae81ff>pipeline-push-on-1.0-tags</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>annotations</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>pipelinesascode.tekton.dev/on-target-branch</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;[refs/tags/1.0]&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>pipelinesascode.tekton.dev/on-event</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;[push]&#34;</span>
</span></span></code></pre></div><p>This will match the pipeline <code>pipeline-push-on-1.0-tags</code> when you push the 1.0
tags into your repository.</p><p>Matching annotations are currently mandated or <code>Pipelines as Code</code> will not
match your <code>PipelineRun</code>.</p><p>If there is multiple pipeline matching an event, it will match the first one. We
are currently not supporting multiple PipelineRuns on a single event, but this
may be something we can consider implementing in the future.</p><h2 id=advanced-event-matching>Advanced event matching
<a class=anchor href=#advanced-event-matching>#</a></h2><p>If you need to do some advanced matching, <code>Pipelines as Code</code> supports CEL
filtering.</p><p>If you have the <code>pipelinesascode.tekton.dev/on-cel-expression</code> annotation in
your PipelineRun, the CEL expression will be used and the <code>on-target-branch</code> or
<code>on-target-branch</code> annotations will then be skipped.</p><p>For example :</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span>    <span style=color:#f92672>pipelinesascode.tekton.dev/on-cel-expression</span><span style=color:#111>:</span> <span style=color:#111>|</span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>      </span>      <span style=color:#ae81ff>event == &#34;pull_request&#34; &amp;&amp; target_branch == &#34;main&#34; &amp;&amp; source_branch == &#34;wip&#34;</span>
</span></span></code></pre></div><p>Will match a <code>pull_request</code> event targeting the branch <code>main</code> coming from a branch called <code>wip</code>.</p><p>The fields available are :</p><ul><li><code>event</code>: <code>push</code> or <code>pull_request</code></li><li><code>target_branch</code>: The branch we are targeting.</li><li><code>source_branch</code>: The branch where this pull_request come from. (on <code>push</code> this is the same as <code>target_branch</code>).</li></ul><p>Compared to the simple &ldquo;on-target&rdquo; annotation matching, the CEL expression
allows you to complex filtering and most importantly express negation.</p><p>For example if I want to have a <code>PipelineRun</code> targeting a <code>pull_request</code> but
not the <code>experimental</code> branch I would have :</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span>    <span style=color:#f92672>pipelinesascode.tekton.dev/on-cel-expression</span><span style=color:#111>:</span> <span style=color:#111>|</span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>      </span>      <span style=color:#ae81ff>event == &#34;pull_request&#34; &amp;&amp; target_branch != experimental&#34;</span>
</span></span></code></pre></div><p>You can find more information about the CEL language spec here :</p><p><a href=https://github.com/google/cel-spec/blob/master/doc/langdef.md>https://github.com/google/cel-spec/blob/master/doc/langdef.md</a></p><h2 id=example>Example
<a class=anchor href=#example>#</a></h2><p><code>Pipelines as code</code> test itself, you can see the examples in its
<a href=https://github.com/openshift-pipelines/pipelines-as-code/tree/main/.tekton>.tekton</a> repository.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/openshift-pipelines/pipelines-as-code/commit/72af6d20df646465713b6cedcdd8720bb28e2713 title="Last modified by Chmouel Boudjnah | March 29, 2022" target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>March 29, 2022</span></a></div><div><a class="flex align-center" href=https://github.com/openshift-pipelines/pipelines-as-code/edit/main/docs/content/docs/guide/autoringprs.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(n){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(n),e.removeAllRanges(),e.addRange(t)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#matching-an-event-to-a-pipelinerun>Matching an event to a PipelineRun</a></li><li><a href=#advanced-event-matching>Advanced event matching</a></li><li><a href=#example>Example</a></li></ul></nav></div></aside></main></body></html>